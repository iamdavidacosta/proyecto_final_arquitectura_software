<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileShare Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            background-color: #f8f9fa;
        }

        .stats-card {
            background: var(--primary-gradient);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stats-card h2 {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .connection-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .connected {
            background-color: #28a745;
            color: white;
        }

        .disconnected {
            background-color: #dc3545;
            color: white;
        }

        .connecting {
            background-color: #ffc107;
            color: black;
        }

        .new-file-row {
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from {
                background-color: #d4edda;
            }
            to {
                background-color: transparent;
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .panel-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            height: 100%;
        }

        .panel-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
        }

        .panel-body {
            padding: 20px;
        }

        .files-table-container {
            max-height: 420px;
            overflow-y: auto;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .search-compact {
            background: white;
            border-radius: 10px;
            padding: 10px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-compact .form-control {
            border: none;
            background: #f8f9fa;
        }

        .search-compact .form-control:focus {
            box-shadow: none;
            background: #f0f0f0;
        }

        .api-compact {
            font-size: 0.85rem;
        }

        .api-compact .api-endpoint {
            padding: 6px 10px;
            margin-bottom: 6px;
        }

        .api-compact code {
            font-size: 0.8rem;
        }

        .table th {
            position: sticky;
            top: 0;
            background: #343a40;
            color: white;
            z-index: 10;
        }

        .api-endpoint {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            transition: all 0.2s;
        }

        .api-endpoint:hover {
            background: #e9ecef;
            border-left-color: #764ba2;
        }

        .api-endpoint code {
            color: #667eea;
            font-weight: 500;
        }

        .api-method {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .method-get {
            background: #28a745;
            color: white;
        }

        .method-delete {
            background: #dc3545;
            color: white;
        }

        .realtime-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .search-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-file-earmark-cloud me-2"></i>FileShare Visualizer
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <span id="connectionStatus" class="connection-status connecting me-3">
                    <i class="bi bi-wifi me-1"></i>Conectando...
                </span>
            </div>
        </div>
    </nav>

    <!-- Toast para notificaciones -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container-fluid mt-4 px-4">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h2 id="totalFilesCount" th:text="${totalFiles != null ? totalFiles : 0}">0</h2>
                            <p class="mb-0">Total de Archivos</p>
                        </div>
                        <i class="bi bi-files" style="font-size: 3rem; opacity: 0.7;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="alert alert-info mb-0 h-100 d-flex align-items-center" style="border-radius: 12px;">
                    <i class="bi bi-broadcast realtime-badge me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>游댃 Actualizaci칩n en Tiempo Real</strong>
                        <p class="mb-0 small">Esta p치gina se actualiza autom치ticamente cuando se suben, modifican o eliminan archivos en el sistema.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Panel - Real-time Files Dashboard -->
            <div class="col-lg-8 mb-4">
                <div class="panel-card">
                    <div class="panel-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-collection me-2"></i>Todos los Archivos (Tiempo Real)</span>
                        <span class="badge bg-light text-dark" id="liveCount">
                            <span th:text="${files != null ? #lists.size(files) : 0}">0</span> archivos
                        </span>
                    </div>
                    <div class="panel-body">
                        <div class="files-table-container">
                            <table class="table table-striped table-hover mb-0" id="filesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Usuario</th>
                                        <th>Tipo</th>
                                        <th>Tama침o</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="filesTableBody">
                                    <tr th:each="file : ${files}">
                                        <td>
                                            <i class="bi bi-file-earmark me-1"></i>
                                            <span th:text="${file.fileName}"></span>
                                        </td>
                                        <td>
                                            <small class="text-muted" th:text="${file.userId != null ? file.userId.substring(0, 8) + '...' : 'N/A'}"></small>
                                        </td>
                                        <td><small th:text="${file.contentType}"></small></td>
                                        <td th:text="${file.fileSize != null ? #numbers.formatDecimal(file.fileSize / 1024.0, 1, 2) + ' KB' : 'N/A'}"></td>
                                        <td>
                                            <span th:class="${file.status == 'Completed' ? 'badge bg-success' : 'badge bg-warning'}" th:text="${file.status}"></span>
                                        </td>
                                        <td>
                                            <small th:text="${file.createdAt != null ? #temporals.format(file.createdAt, 'dd/MM HH:mm') : 'N/A'}"></small>
                                        </td>
                                    </tr>
                                    <tr th:if="${files == null or #lists.isEmpty(files)}" id="noFilesRow">
                                        <td colspan="6" class="text-center py-5">
                                            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                                            <p class="text-muted mt-2 mb-0">No hay archivos registrados en el sistema</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - User Search & API Docs -->
            <div class="col-lg-4 mb-4">
                <!-- Compact Search -->
                <form action="/files" method="get" class="search-compact mb-3">
                    <i class="bi bi-search text-muted"></i>
                    <input type="text" class="form-control form-control-sm" id="userId" name="userId" 
                           placeholder="Buscar por User ID (UUID)..." required>
                    <button type="submit" class="btn btn-primary btn-sm px-3">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </form>

                <!-- API Documentation Section -->
                <div class="panel-card">
                    <div class="panel-header py-2" style="font-size: 0.9rem;">
                        <i class="bi bi-code-slash me-2"></i>API Endpoints
                    </div>
                    <div class="panel-body py-2 px-3 api-compact">
                        <div class="api-endpoint"><span class="api-method method-get">GET</span><code>/api/visualizer/files/{fileId}</code></div>
                        <div class="api-endpoint"><span class="api-method method-get">GET</span><code>/api/visualizer/users/{userId}/files</code></div>
                        <div class="api-endpoint"><span class="api-method method-get">GET</span><code>/api/visualizer/files/{fileId}/download</code></div>
                        <div class="api-endpoint"><span class="api-method method-delete">DELETE</span><code>/api/visualizer/files/{fileId}?userId={userId}</code></div>
                        <div class="d-flex gap-2 mt-2 pt-2 border-top">
                            <a href="/dashboard" class="btn btn-outline-secondary btn-sm flex-fill py-1">
                                <i class="bi bi-speedometer2 me-1"></i>Dashboard
                            </a>
                            <a href="/api/visualizer/health" class="btn btn-outline-success btn-sm flex-fill py-1" target="_blank">
                                <i class="bi bi-heart-pulse me-1"></i>Health
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        function connect() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = '<i class="bi bi-wifi me-1"></i>Conectando...';
            statusEl.className = 'connection-status connecting';

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            // Deshabilitar logs de STOMP en consola
            stompClient.debug = null;

            stompClient.connect({},
                function (frame) {
                    console.log('WebSocket conectado');
                    statusEl.innerHTML = '<i class="bi bi-wifi me-1"></i>Conectado';
                    statusEl.className = 'connection-status connected';
                    reconnectAttempts = 0;

                    // Suscribirse a eventos de archivos individuales
                    stompClient.subscribe('/topic/files', function (message) {
                        const event = JSON.parse(message.body);
                        console.log('Evento recibido:', event);
                        handleFileEvent(event);
                    });

                    // Suscribirse a la lista completa de archivos
                    stompClient.subscribe('/topic/files-list', function (message) {
                        const files = JSON.parse(message.body);
                        console.log('Lista actualizada recibida:', files.length, 'archivos');
                        updateFilesTable(files);
                    });
                },
                function (error) {
                    console.error('Error WebSocket:', error);
                    statusEl.innerHTML = '<i class="bi bi-wifi-off me-1"></i>Desconectado';
                    statusEl.className = 'connection-status disconnected';

                    // Intentar reconectar
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log('Intentando reconectar... (' + reconnectAttempts + '/' + maxReconnectAttempts + ')');
                        setTimeout(connect, 3000);
                    }
                }
            );
        }

        function handleFileEvent(event) {
            showToast(event);
        }

        function updateFilesTable(files) {
            const tbody = document.getElementById('filesTableBody');
            const countEl = document.getElementById('totalFilesCount');
            const liveCountEl = document.getElementById('liveCount');

            countEl.textContent = files.length;
            liveCountEl.innerHTML = files.length + ' archivos';

            if (files.length === 0) {
                tbody.innerHTML = `
                    <tr id="noFilesRow">
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-2 mb-0">No hay archivos registrados en el sistema</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Obtener IDs existentes para detectar nuevos
            const existingIds = Array.from(tbody.querySelectorAll('tr[data-file-id]'))
                .map(row => row.dataset.fileId);

            tbody.innerHTML = files.map(file => {
                const isNew = !existingIds.includes(file.fileId);
                const userId = file.userId ? file.userId.substring(0, 8) + '...' : 'N/A';
                const size = file.fileSize ? (file.fileSize / 1024).toFixed(2) + ' KB' : 'N/A';
                const statusClass = file.status === 'Completed' ? 'bg-success' : 'bg-warning';
                const createdAt = file.createdAt ? formatDateTime(file.createdAt) : 'N/A';
                const icon = getFileIcon(file.contentType);

                return `
                    <tr data-file-id="${file.fileId}" class="${isNew ? 'new-file-row' : ''}">
                        <td><i class="bi ${icon} me-1"></i>${file.fileName || 'N/A'}</td>
                        <td><small class="text-muted">${userId}</small></td>
                        <td><small>${file.contentType || 'N/A'}</small></td>
                        <td>${size}</td>
                        <td><span class="badge ${statusClass}">${file.status || 'N/A'}</span></td>
                        <td><small>${createdAt}</small></td>
                    </tr>
                `;
            }).join('');
        }

        function getFileIcon(contentType) {
            if (!contentType) return 'bi-file-earmark';
            if (contentType.includes('image')) return 'bi-file-earmark-image';
            if (contentType.includes('pdf')) return 'bi-file-earmark-pdf';
            if (contentType.includes('word') || contentType.includes('document')) return 'bi-file-earmark-word';
            if (contentType.includes('excel') || contentType.includes('spreadsheet')) return 'bi-file-earmark-excel';
            if (contentType.includes('zip') || contentType.includes('rar')) return 'bi-file-earmark-zip';
            if (contentType.includes('text')) return 'bi-file-earmark-text';
            return 'bi-file-earmark';
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            try {
                const date = new Date(dateTimeStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month} ${hours}:${minutes}`;
            } catch (e) {
                return dateTimeStr;
            }
        }

        function showToast(event) {
            const container = document.getElementById('toastContainer');
            const eventTypeConfig = {
                'INSERT': { label: 'Nuevo archivo', icon: 'bi-file-earmark-plus', bg: 'bg-success' },
                'UPDATE': { label: 'Archivo actualizado', icon: 'bi-pencil-square', bg: 'bg-info' },
                'DELETE': { label: 'Archivo eliminado', icon: 'bi-trash', bg: 'bg-danger' }
            };

            const config = eventTypeConfig[event.eventType] || { label: 'Cambio detectado', icon: 'bi-bell', bg: 'bg-primary' };
            const toastId = 'toast-' + Date.now();

            const toastHtml = `
                <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${config.bg} text-white">
                        <i class="bi ${config.icon} me-2"></i>
                        <strong class="me-auto">${config.label}</strong>
                        <small>Ahora</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Cerrar"></button>
                    </div>
                    <div class="toast-body">
                        <i class="bi bi-file-earmark me-1"></i>${event.fileName || 'Archivo actualizado'}
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);

            // Auto-remover despu칠s de 5 segundos
            setTimeout(() => {
                const toastEl = document.getElementById(toastId);
                if (toastEl) {
                    toastEl.classList.remove('show');
                    setTimeout(() => toastEl.remove(), 300);
                }
            }, 5000);
        }

        // Conectar cuando la p치gina cargue
        document.addEventListener('DOMContentLoaded', connect);
    </script>
</body>

</html>
