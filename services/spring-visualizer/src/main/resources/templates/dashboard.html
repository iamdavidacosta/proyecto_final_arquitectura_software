<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FileShare Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-card h2 {
            font-size: 3rem;
            font-weight: bold;
        }

        .connection-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .connected {
            background-color: #28a745;
            color: white;
        }

        .disconnected {
            background-color: #dc3545;
            color: white;
        }

        .connecting {
            background-color: #ffc107;
            color: black;
        }

        .new-file-row {
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from {
                background-color: #d4edda;
            }

            to {
                background-color: transparent;
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">FileShare Visualizer</a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <span id="connectionStatus" class="connection-status connecting me-3">Conectando...</span>
                <a class="nav-link active" href="/dashboard">Dashboard</a>
            </div>
        </div>
    </nav>

    <!-- Toast para notificaciones -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="stats-card">
                    <h2 id="totalFilesCount" th:text="${totalFiles}">0</h2>
                    <p class="mb-0">Total de Archivos</p>
                </div>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info" id="realtimeInfo">
                    <strong>üîÑ Tiempo Real:</strong> Esta p√°gina se actualiza autom√°ticamente cuando se suben nuevos
                    archivos.
                </div>
            </div>
        </div>

        <h2 class="mb-4">Todos los Archivos</h2>

        <div class="table-responsive">
            <table class="table table-striped table-hover" id="filesTable">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre del Archivo</th>
                        <th>Usuario ID</th>
                        <th>Content Type</th>
                        <th>Tama√±o</th>
                        <th>Status</th>
                        <th>Creado</th>
                    </tr>
                </thead>
                <tbody id="filesTableBody">
                    <tr th:each="file : ${files}">
                        <td th:text="${file.fileName}"></td>
                        <td>
                            <small
                                th:text="${file.userId != null ? file.userId.substring(0, 8) + '...' : 'N/A'}"></small>
                        </td>
                        <td th:text="${file.contentType}"></td>
                        <td
                            th:text="${file.fileSize != null ? #numbers.formatDecimal(file.fileSize / 1024.0, 1, 2) + ' KB' : 'N/A'}">
                        </td>
                        <td>
                            <span th:class="${file.status == 'Completed' ? 'badge bg-success' : 'badge bg-warning'}"
                                th:text="${file.status}"></span>
                        </td>
                        <td
                            th:text="${file.createdAt != null ? #temporals.format(file.createdAt, 'yyyy-MM-dd HH:mm') : 'N/A'}">
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(files)}" id="noFilesRow">
                        <td colspan="6" class="text-center py-4">
                            <p class="text-muted mb-0">No hay archivos registrados en el sistema</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <a href="/" class="btn btn-secondary">Volver al Inicio</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        function connect() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = 'Conectando...';
            statusEl.className = 'connection-status connecting';

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            // Deshabilitar logs de STOMP en consola
            stompClient.debug = null;

            stompClient.connect({},
                function (frame) {
                    console.log('WebSocket conectado');
                    statusEl.textContent = 'üü¢ Conectado';
                    statusEl.className = 'connection-status connected';
                    reconnectAttempts = 0;

                    // Suscribirse a eventos de archivos individuales
                    stompClient.subscribe('/topic/files', function (message) {
                        const event = JSON.parse(message.body);
                        console.log('Evento recibido:', event);
                        handleFileEvent(event);
                    });

                    // Suscribirse a la lista completa de archivos
                    stompClient.subscribe('/topic/files-list', function (message) {
                        const files = JSON.parse(message.body);
                        console.log('Lista actualizada recibida:', files.length, 'archivos');
                        updateFilesTable(files);
                    });
                },
                function (error) {
                    console.error('Error WebSocket:', error);
                    statusEl.textContent = 'üî¥ Desconectado';
                    statusEl.className = 'connection-status disconnected';

                    // Intentar reconectar
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log('Intentando reconectar... (' + reconnectAttempts + '/' + maxReconnectAttempts + ')');
                        setTimeout(connect, 3000);
                    }
                }
            );
        }

        function handleFileEvent(event) {
            showToast(event);
        }

        function updateFilesTable(files) {
            const tbody = document.getElementById('filesTableBody');
            const countEl = document.getElementById('totalFilesCount');

            countEl.textContent = files.length;

            if (files.length === 0) {
                tbody.innerHTML = `
                    <tr id="noFilesRow">
                        <td colspan="6" class="text-center py-4">
                            <p class="text-muted mb-0">No hay archivos registrados en el sistema</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Obtener IDs existentes para detectar nuevos
            const existingIds = Array.from(tbody.querySelectorAll('tr[data-file-id]'))
                .map(row => row.dataset.fileId);

            tbody.innerHTML = files.map(file => {
                const isNew = !existingIds.includes(file.fileId);
                const userId = file.userId ? file.userId.substring(0, 8) + '...' : 'N/A';
                const size = file.fileSize ? (file.fileSize / 1024).toFixed(2) + ' KB' : 'N/A';
                const statusClass = file.status === 'Completed' ? 'bg-success' : 'bg-warning';
                const createdAt = file.createdAt ? formatDateTime(file.createdAt) : 'N/A';

                return `
                    <tr data-file-id="${file.fileId}" class="${isNew ? 'new-file-row' : ''}">
                        <td>${file.fileName || 'N/A'}</td>
                        <td><small>${userId}</small></td>
                        <td>${file.contentType || 'N/A'}</td>
                        <td>${size}</td>
                        <td><span class="badge ${statusClass}">${file.status || 'N/A'}</span></td>
                        <td>${createdAt}</td>
                    </tr>
                `;
            }).join('');
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            try {
                const date = new Date(dateTimeStr);
                return date.toISOString().slice(0, 16).replace('T', ' ');
            } catch (e) {
                return dateTimeStr;
            }
        }

        function showToast(event) {
            const container = document.getElementById('toastContainer');
            const eventTypeLabels = {
                'INSERT': 'üìÅ Nuevo archivo',
                'UPDATE': '‚úèÔ∏è Archivo actualizado',
                'DELETE': 'üóëÔ∏è Archivo eliminado'
            };

            const label = eventTypeLabels[event.eventType] || 'üìã Cambio detectado';
            const toastId = 'toast-' + Date.now();

            const toastHtml = `
                <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">${label}</strong>
                        <small>Ahora</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
                    </div>
                    <div class="toast-body">
                        ${event.fileName || 'Archivo actualizado'}
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);

            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                const toastEl = document.getElementById(toastId);
                if (toastEl) toastEl.remove();
            }, 5000);
        }

        // Conectar cuando la p√°gina cargue
        document.addEventListener('DOMContentLoaded', connect);
    </script>
</body>

</html>